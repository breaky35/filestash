# STEP1: CLONE THE CODE
FROM alpine/git as builder_prepare
WORKDIR /home/
ARG GIT_REPO=https://github.com/breaky35/filestash
ARG GIT_BRANCH=master
RUN git clone --depth 1 --single-branch --branch ${GIT_BRANCH} ${GIT_REPO}

# STEP2: BUILD BACKEND
FROM golang:1.24-trixie AS builder_backend
WORKDIR /home/filestash/
COPY --from=builder_prepare /home/filestash/ .
RUN apt-get update > /dev/null && \
    apt-get install -y curl make > /dev/null 2>&1 && \
    apt-get install -y libjpeg-dev libtiff-dev libpng-dev libwebp-dev libraw-dev libheif-dev libgif-dev libvips-dev > /dev/null 2>&1 && \
    make build_init && \
    make build_backend

# STEP3: BUILD PROD IMAGE
FROM debian:stable-slim
WORKDIR /app/
COPY --from=builder_backend /home/filestash/dist/filestash /app/filestash
RUN apt-get update > /dev/null && \
    apt-get install -y --no-install-recommends apt-utils curl ffmpeg libjpeg-dev libtiff-dev libpng-dev libwebp-dev libraw-dev libheif-dev libgif-dev && \
    useradd -m filestash && \
    chown -R filestash:filestash /app/ && \
    chmod +x /app/filestash && \
    rm -rf /var/lib/apt/lists/* /tmp/*

USER filestash
CMD ["/app/filestash"]
EXPOSE 8334
